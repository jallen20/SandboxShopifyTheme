{% schema %}
{
  "name": "Google Map Section",
  "settings": [
    {
      "type": "text",
      "id": "map_title",
      "label": "Section Title",
      "default": "Our Location"
    },
    {
      "type": "text",
      "id": "latitude",
      "label": "Latitude",
      "default": "33.792"
    },
    {
      "type": "text",
      "id": "longitude",
      "label": "Longitude",
      "default": "-84.336"
    },
    {
      "type": "range",
      "id": "zoom",
      "label": "Zoom Level",
      "min": 1,
      "max": 20,
      "step": 1,
      "default": 11
    },
    {
      "type": "text",
      "id": "map_id",
      "label": "Google Map ID",
      "default": "DEMO_MAP_ID"
    },
    {
      "type": "text",
      "id": "api_key",
      "label": "Google Maps API Key",
      "default": "YOUR_API_KEY"
    },
    {
      "type": "text",
      "id": "map_height",
      "label": "Map Height (px or %)",
      "default": "400px"
    }
  ],
  "presets": [
    {
      "name": "Google Map",
      "category": "Custom"
    }
  ]
}
{% endschema %}

<section class="google-map-section">
    {% if section.settings.map_title != blank %}
        <h2 class="map-title">{{ section.settings.map_title }}</h2>
    {% endif %}

    <gmp-map
            id="map"
            heading-interaction-disabled
            center="{{ section.settings.latitude }},{{ section.settings.longitude }}"
            zoom="{{ section.settings.zoom }}"
            map-id="{{ section.settings.map_id }}"
            style="height: {{ section.settings.map_height }}; width: 100%;"
    ></gmp-map>

    <script
            src="https://maps.googleapis.com/maps/api/js?key={{ section.settings.api_key }}&callback=initMap&v=weekly"
            defer
    ></script>

    <script>
        (function () {
            // Apply options AFTER <gmp-map> upgrades and exposes its inner map
            function applyOptions() {
                const el = document.getElementById('map');
                if (!el) return;

                // If the element isn't upgraded yet, wait for it
                if (window.customElements?.whenDefined) {
                    customElements.whenDefined('gmp-map').then(() => setOpts(el));
                } else {
                    setOpts(el);
                }
            }

            function setOpts(el) {
                const map = el.innerMap || (el.getMap?.() ?? null);
                if (!map) {
                    // try again shortly if innerMap isn't ready yet
                    setTimeout(() => setOpts(el), 50);
                    return;
                }
                // Disable all default controls
                map.setOptions({
                    disableDefaultUI: true,
                    zoomControl: true,
                    mapTypeControl: false,
                    streetViewControl: false,
                    fullscreenControl: false,
                    rotateControl: false,
                    scaleControl: false,
                    tilt: 0,
                    heading: 0
                });
            }

            // Run when DOM is ready
            document.addEventListener('DOMContentLoaded', applyOptions);
            // Also handle Shopify dynamic section loads (theme editor)
            document.addEventListener('shopify:section:load', applyOptions);
        })();
    </script>




    <style>
        .google-map-section {
            text-align: center;
            padding: 20px 0;
        }

        .google-map-section .map-title {
            font-size: 1.5rem;
            margin-bottom: 10px;
        }

        gmp-map {
            border-radius: 8px;
            overflow: hidden;
            display: block;
        }
    </style>
</section>
